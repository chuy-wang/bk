### InnoDB不支持在线修改表结构的场景

| 操作       | 语法                                                         |
| ---------- | ------------------------------------------------------------ |
| 加全文索引 | CREATE FULLTEXT INDEX name NO table(column);                 |
| 加空间索引 | ALTER TABLE GEOM ADD SPATIAL INDEX(g);                       |
| 删除主键   | ALTER TABLE tbl_name DROP PRIMARY KEY;                       |
| 增加自增列 | ALTER TABLE t ADD COLUMN id int auto_increment not null primary key; |
| 修改列类型 | ALTER TABLE tbl_name CHANGE c1 c1 `NEW_TYPE`                 |
| 修改字符集 | ALTER TABLE tbl_name CHARACTER SET = charset_name;           |

有部分语句不支持在线DDL

长时间的DDL操作会引起严重的主从延迟

无法对DDL操作进行资源限制（临时表空间不足，造成失败）

###如何更安全的执行DDL

```bash
pt-online-schema-change [OPTIONS] DSN
```

### InnoDB如何实现事务的

####什么是事务？

| 特征        | 说明                                                         |
| ----------- | ------------------------------------------------------------ |
| 原子性（A） | 一个事务中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节 |
| 一致性（C） | 在事务开始之前和事务结束之后，数据库的完整性没有被破坏       |
| 隔离性（I） | 事务的隔离性要求每个读写事务的对象与其他事务的操作对象能相互分离，即该事物提交前对其他事务都不可见 |
| 持久性（D） | 事务一旦提交了，其结果就是永久性的，就算发生了宕机等事故，数据库也能将数据恢复 |

#### 事务的实现方式

| 特征        | InnoDB实现方式                                 |
| ----------- | ---------------------------------------------- |
| 原子性（A） | 回滚日志（undo log）：用于记录数据修改前的状态 |
| 一致性（C） | 重做日志（redo log）：用于记录数据修改后的状态 |
| 隔离性（I） | 锁：用于资源隔离，分为共享锁和排它锁           |
| 持久性（D） | 重做日志（redo log） + 回滚日志（undo log）    |

### 读写应该相互阻塞么？

查询需要对资源加共享锁（S）

数据修改需要对资源加排它锁（X）

|        | 排它锁 | 共享锁 |
| ------ | ------ | ------ |
| 排它锁 | 不兼容 | 不兼容 |
| 共享锁 | 不兼容 | 兼容   |

### MVCC

